{% load staticfiles %}

<script>
    $(document).ready(function() {
    $(".submit-comment").click(function (event) {
        event.preventDefault();
        var formData = $(this).parent(".comment-form").serialize();
        var image = $(this).siblings('.image-field').children("#image").val();
        var text = $(this).siblings("#text").val();
        console.log(formData);
        if (image) {
            alert("Need to reload to be able to save image");
            $(this).parent(".comment-form").submit();

        } else if (text === "") {
            alert("Post not posted. Add a picture or a post");
        } else {
            $.ajax({
                type: "POST",
                url: "{% url 'chat:post_comment' %}",
                data: formData,
                success: function (data) {
                    alert("Comment Added!");
                    var newPost = '<p><img src="{{ user.picture.url }}" class="profile_pic"/> ';
                    newPost += '<a href="" class="name">{{ user }}</a>';
                    newPost += ' ' + data.comment +'</p>';
                    $("#new-post-"+data.pk).html(newPost);
                    // $("#comment-form-"+data.pk).siblings("p").children(".reply").css("display", "inline");
                    $("#comment-form-"+data.pk).css("display", "none");
                },
                error: function (error) {
                    alert(error.status + ": " + error.statusText);
                    $(this).parent(".comment-form").submit();
                }
            });

        }
    });

    $(".like-unlike-form").submit(function (event) {
        // likes and likes posts
        event.preventDefault();
        var data = $(this).serialize();
        $.ajax({
            type: "POST",
            data: data,
            url: "{% url 'chat:like/unlike' %}",
            success: function (data) {
                alert("This is a flash message: " + data.flash_message);
                if (data.likes > 0) {
                    console.log(data.post_pk + '  ' + data.likes);
                    $("#like-form-"+data.post_pk).siblings(".likes").css("display", "inline").text(data.likes + " likes");
                } else {
                    $("#like-form-"+data.post_pk).siblings(".likes").text("");
                }
            },
            error: function (error) {
                alert("didn't work");
                console.log(error.status + ": " + error.statusText);
                // $(".like-unlike-form").submit();       This will recall this function again and again making a never ending loop
            }
        })
    });

    $('.share-form').submit(function (event) {
        // s ahres the post
        event.preventDefault();
        var data = $(this).serialize();
        $.ajax({
            type: "POST",
            data: data,
            url: "{% url 'chat:share' %}",
            success: function (data) {
                alert("Shared");
                $("#share-form-" + data.post_pk).css("display", "none");
                var newText = "<h5>";
                newText += '<img src="{{ user.picture.url }}" class="profile_pic"/>';
                newText += '<a href="" class="name">{{ user }}</a> shared <strong>' + data.post_title + '</strong>';
                newText += "</h5>";
                alert(newText);
                $("#new-ajax-sharer-" + data.post_pk).html(newText);
            },
            error: function (error) {
                alert(error.status + ": " + error.statusText);
                // $(".share-form").submit();
            }
        });
    });
    });
</script>