{% extends "layout.html" %}

{% load template_func %}

<script>
    {% block javascript %}
        $(function() {
            var image;
            $(".image-link").click(function (event) {
                //  TODO: fix 2 bugs 1)only show more one file input
                // TODO: 2) when press X on file with nothing doesnt let you open two at same time
                event.preventDefault();

                if ($(this).next().hasClass("image-link") === true) {
                    // meaning X button was pressed
                    alert("X was pressed");
                    $(this).css("display", "none");
                    image = $(this).siblings('.image-field').children('.image').detach();
                    if (image) {
                        alert("Its saved for now");
                    }
                    // $(this).siblings('.hidden-items').css("display", "none");
                    $(this).siblings("#image-button").css("display", "inline");
                } else {
                    // meaning camera button was pressed
                    if (image) {
                        alert("image is saved");
                        image.appendTo($(this).siblings(".image-field"));
                        image = null;
                    }
                    $(this).siblings('.hidden-items').css("display", "inline");
                    $(this).next(type = "hidden").submit();
                    $(this).css("display", "none")
                }


            });
        });

        $(function() {
            $(".remove-picture").click(function(event) {
                event.preventDefault();
                alert("Went well");
                $(this).css("display", "none");
                $(this).prev('.image').detach();
                $(this).prev('.image').css("display", "none");
                $(this).offsetParent().siblings(".image-link").css("display", "inline");
            });
        });



        $("#submit-post").click(function() {
            // event.preventDefault();
            formData = {
                image: $('#id_image').val(),
                text: $('#id_text').val(),
                title: $("#id_title").val(),
                share: $("#id_share").val()
            };
            {% comment %}$.ajax({
                type: $(this).attr('method'),
                url: "{% url 'chat:chat' %}",
                data: formData,
                success: function(data) {
                    if (formData.image) {
                        alert("Need to reload");
                        $("#post-form").submit();
                    } else {
                        alert("Went well");
                        $("#new-post").text("NEW POST: '"+ formData.title + "'");
                        $("#more-post").fadeIn();
                        $("#post-form").fadeOut();
                    }
                },
                error: function(response, error) {
                    alert("Need to reload");
                }
            }){% endcomment %}
        });
    {% endblock %}
</script>

{% block title %}ChatBox{% endblock %}

{% block content %}
    <div class="col-sm-6 col-sm-offset-3">

   {% comment %}     <form action="{% url 'chat:fast_post' %}" method="POST" enctype="multipart/form-data">
            <input type="text" name="title">
            <input type="text" name="text">
            Share with: <input type="radio" name="share" value="Public">Public
            <input type="radio" name="share" value="Friends">Friends
            {% csrf_token %}
            <input type="submit" value="post" class="button-form">
        </form>{% endcomment %}
     <form id="post-form" method="POST" action="" enctype="multipart/form-data">
        <p  id="title">{{ form.title }}</p>
        <p id="image">{{ form.image }}</p>
        <p id="text">{{ form.text }}</p>
        <p id="share">{{ form.share }}</p>
        {% csrf_token %}
        <input type="submit" class="btn btn-primary" id="submit-post" value="Post">
    </form>
        <a href="{% url 'chat:chat' %}" class="btn btn-primary" id="more-post" style="display: none">Post More</a>
        <br/><br/>

    <div class="row">
     <h3 id="new-post"></h3>
    {% for post in posts %}
        {% post_filter post user friends as post_good %}
        {% if post_good %}
        <div class="row">
        <div class="col-sm-12">
            <div class="thumbnail">
                <div class="caption">

                    <h3><img src="{{ post.user.picture.url }}" class="profile_pic" />
                        {{ post.title }}
                        <small> from {{ post.user }} {{ post.time_posted|timesince }} ago</small>
                    </h3>
                    {% if post.image %}
                        <img src="{{ post.image.url }}" class="img-responsive" />
                    {% endif %}
                    <p class="post-text" style="">{{ post.text|linebreaks }}</p>
                    <p><small>{{ post.share }}</small></p>
{#                    <p><a href="{% url 'chat:comment' pk=post.pk %}" class="btn btn-primary" role="button">Comment</a>#}

                    <form class="comment-form" method="POST" action="{% url 'chat:post_comment' %}" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="form-group"><input type="text" name="text"  placeholder="text" value="{{ request.GET.text }}" />

                        <div class="hidden-items image-field">
                            <input type="file" name="image" placeholder="image" class="image" value="{{ request.GET.image }}" />

                        </div>
                        <button class="btn-danger hidden-items image-link">X</button>
                        <button class="btn-info image-link" id="image-button"><i class="fa fa-camera-retro fa-1.5x image-link" aria-hidden="true"></i></button>
                        <input type="hidden" name="pk" value="{{ post.pk }}">

                        <input type="submit" class="btn btn-primary submit-comment" value="Comment" /></div>
                    </form>
                    {% has_comments post 2 as comments %}
                    {% if comments %}
                        {% comments_list comments %}
                    {% endif %}
                </div>
            </div>
        </div>
        <hr/>
        </div>
        {% endif %}
    {% endfor %}

        <div class="pagination">
    <span class="step-links">
        {% if posts.has_previous %}
            <a href="?page={{ posts.previous_page_number }}">previous</a>
        {% endif %}

        <span class="current">
            Page {{ posts.number }} of {{ posts.paginator.num_pages }}.
        </span>

        {% if posts.has_next %}
            <a href="?page={{ posts.next_page_number }}">next</a>
        {% endif %}
    </span>
    </div>
    </div>
    </div>
{% endblock %}